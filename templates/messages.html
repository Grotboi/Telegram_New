<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>üí¨ –ß–∞—Ç</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <!-- –®—Ä–∏—Ñ—Ç Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    display: ['Inter', 'system-ui', '-apple-system'],
                    body: ['Inter', 'system-ui', '-apple-system'],
                },
                extend: {
                    colors: {
                        'telegram': '#0088cc',
                        'telegram-hover': '#0078b8',
                        'msg-sent': '#0088cc',
                        'msg-received': '#ffffff',
                        'status-green': '#4cc075',
                        'border-light': '#e0e0e0',
                        'chat-bg': '#f0f2f5',
                        'header-bg': '#f8f9fa',
                        'sidebar-backdrop': 'rgba(0, 0, 0, 0.5)', // –ù–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é
                    },
                    borderRadius: {
                        'message': '14px',
                    }
                }
            }
        }
    </script>

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–æ–ª–ª —É–±–∏—Ä–∞–µ–º */
        }

        #messages {
            scrollbar-width: thin;
            scrollbar-color: #c5c5c5 transparent;
        }

        #messages::-webkit-scrollbar {
            width: 6px;
        }

        #messages::-webkit-scrollbar-track {
            background: transparent;
        }

        #messages::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 3px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∏ —Ñ–æ–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            position: fixed; /* –ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
            top: 0;
            left: 0;
            height: 100vh; /* –í—ã—Å–æ—Ç–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
            z-index: 50; /* –í—ã—Å–æ–∫–∏–π z-index */
            transform: translateX(-100%); /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        /* –§–æ–Ω –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        #sidebarBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: theme('colors.sidebar-backdrop'); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ Tailwind */
            z-index: 40; /* –ù–∏–∂–µ, —á–µ–º —Å–∞–π–¥–±–∞—Ä */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        /* –ö–ª–∞—Å—Å, –¥–æ–±–∞–≤–ª—è–µ–º—ã–π –∫ body –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é */
        body.sidebar-open #sidebar {
            transform: translateX(0); /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º */
        }

        body.sidebar-open #sidebarBackdrop {
            opacity: 1;
            visibility: visible;
        }

        /* –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö –º–µ–Ω—é –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ, —Ñ–æ–Ω –Ω–µ –Ω—É–∂–µ–Ω */
        @media (min-width: 768px) {
            #sidebar {
                position: relative; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –æ–±—ã—á–Ω–æ–º—É –ø–æ—Ç–æ–∫—É –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
                transform: translateX(0) !important; /* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ */
                box-shadow: none !important; /* –£–±–∏—Ä–∞–µ–º —Ç–µ–Ω—å, –µ—Å–ª–∏ –±—ã–ª–∞ */
            }

            #sidebarBackdrop {
                display: none !important; /* –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ–Ω –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            }

            body.sidebar-open #chatContainer {
                /* –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø—Ä–æ—Å—Ç–æ —É–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
                margin-left: 0; /* –ò–ª–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å md:ml-72 –≤ –∫–ª–∞—Å—Å–∞—Ö */
                transform: none !important;
            }
        }
    </style>
</head>
<body class="bg-chat-bg font-body h-screen overflow-hidden"> <!-- overflow-hidden –Ω–∞ body -->

<!-- –§–æ–Ω –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è -->
<div id="sidebarBackdrop"></div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div class="flex h-screen max-h-screen relative w-full">

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div id="sidebar"
         class="w-72 bg-white border-r border-gray-200 flex flex-col shadow-xl"> <!-- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ–Ω—å -->
        <!-- –®–∞–ø–∫–∞ -->
        <div class="p-4 bg-white border-b border-gray-200 flex items-center space-x-3 shadow-sm">
            <div class="w-10 h-10 rounded-full bg-telegram flex items-center justify-center text-white">
                <i class="fas fa-comment-dots text-sm"></i>
            </div>
            <span class="font-bold text-lg text-gray-800">–ß–∞—Ç</span>
        </div>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="p-3 flex items-center space-x-3 bg-white border-b border-gray-100">
            <!-- –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ session['username'] –¥–æ—Å—Ç—É–ø–Ω–∞ -->
            {% set username = session['username'] %}
            {% set first_letter = (username[0].upper() if username else '?') %}
            <div class="w-10 h-10 rounded-full bg-telegram flex items-center justify-center text-white font-semibold text-sm">
                {{ first_letter }}
            </div>
            <div class="flex-1 min-w-0">
                <div class="font-medium text-gray-800 truncate">{{ username }}</div>
                <div class="text-xs text-status-green flex items-center">
                    <i class="fas fa-circle text-xs mr-1"></i>
                    –û–Ω–ª–∞–π–Ω
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div class="flex-1 overflow-y-auto p-2 space-y-1">
            <h3 class="px-3 py-2 text-xs uppercase text-gray-500 font-semibold tracking-wider">–ß–∞—Ç—ã</h3>
            <ul id="users-list" class="space-y-1">
                <li class="user active flex items-center p-3 rounded-lg cursor-pointer hover:bg-blue-50 bg-blue-50"
                    data-recipient="null">
                    <div class="w-10 h-10 rounded-full bg-telegram flex items-center justify-center text-white text-sm">
                        üåê
                    </div>
                    <div class="ml-3">
                        <div class="font-medium text-gray-800">–û–±—â–∏–π —á–∞—Ç</div>
                    </div>
                </li>
            </ul>
        </div>

        <!-- –í—ã—Ö–æ–¥ -->
        <div class="p-3 border-t border-gray-100">
            <a href="/logout" class="text-gray-500 hover:text-gray-700 text-sm flex items-center space-x-1">
                <i class="fas fa-sign-out-alt"></i>
                <span>–í—ã–π—Ç–∏</span>
            </a>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <!-- –£–±—Ä–∞–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –∫–ª–∞—Å—Å—ã ml, —Ç–µ–ø–µ—Ä—å —à–∏—Ä–∏–Ω–∞ –∏ –ø–æ–∑–∏—Ü–∏—è —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–∞–º–∏ –∏ CSS -->
    <div id="chatContainer"
         class="flex-1 flex flex-col max-h-screen bg-white transition-all duration-300 ease-in-out w-full">
        <!-- –ú–æ–±–∏–ª—å–Ω–∞—è —à–∞–ø–∫–∞ -->
        <div class="md:hidden flex items-center p-3 bg-header-bg border-b border-gray-200">
            <button id="menuToggle" class="text-gray-600 mr-3 z-10"> <!-- z-10 —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –≤—ã—à–µ —Ñ–æ–Ω–∞ -->
                <i class="fas fa-bars text-lg"></i>
            </button>
            <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white text-xs">
                <span id="chatAvatar">üåê</span>
            </div>
            <div class="font-medium text-gray-800 truncate" id="chatTitle">–û–±—â–∏–π —á–∞—Ç</div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è - —Ç–µ–ø–µ—Ä—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–æ–ª–ª –∑–¥–µ—Å—å -->
        <div id="messages"
             class="flex-1 overflow-y-auto overflow-x-hidden space-y-2 px-3 py-4 bg-gradient-to-b from-gray-50 to-white">
             <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>

        <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
        <form id="messageForm" class="p-3 bg-white border-t border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <input
                        type="text"
                        id="messageInput"
                        placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-telegram text-base"
                        required
                />
                <button
                        type="submit"
                        class="w-12 h-12 rounded-full bg-telegram hover:bg-telegram-hover text-white flex items-center justify-center text-xl flex-shrink-0"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
    // *** –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ session['username'] –ø–µ—Ä–µ–¥–∞–Ω–æ –∫–∞–∫ JS –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è ***
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä —á–µ—Ä–µ–∑ —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä
    const currentUser = "{{ session['username'] }}"; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    // ***

    let currentRecipient = null;

    const socket = io();
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const messagesDiv = document.getElementById('messages');
    const usersList = document.getElementById('users-list');
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const chatContainer = document.getElementById('chatContainer');
    const chatTitle = document.getElementById('chatTitle');
    const chatAvatar = document.getElementById('chatAvatar');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop'); // –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
    const body = document.body; // –ü–æ–ª—É—á–∞–µ–º body

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    function isMobile() {
        return window.innerWidth < 768; // –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å md –≤ Tailwind
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞
    function toggleSidebar(open) {
        if (open === undefined) {
            open = !body.classList.contains('sidebar-open');
        }

        if (open) {
            body.classList.add('sidebar-open');
        } else {
            body.classList.remove('sidebar-open');
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é
    menuToggle?.addEventListener('click', () => {
        toggleSidebar(); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    });

     // –ö–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É —Ç–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é
    sidebarBackdrop?.addEventListener('click', () => {
        toggleSidebar(false);
    });

    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', () => {
        if (!isMobile()) {
             // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å
            body.classList.remove('sidebar-open');
        }
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞
        scrollToBottom();
    });


    // –í—ã–±–æ—Ä —á–∞—Ç–∞
    function selectChat(recipient, title = "–û–±—â–∏–π —á–∞—Ç", avatar = "üåê") {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
        document.querySelectorAll('.user').forEach(el => el.classList.remove('active', 'bg-blue-50'));
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
        const item = Array.from(usersList.children).find(li => li.dataset.recipient === String(recipient));
        if (item) item.classList.add('active', 'bg-blue-50');

        currentRecipient = recipient;
        chatTitle.textContent = title;
        chatAvatar.textContent = avatar;

        // –ï—Å–ª–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
        if (isMobile()) {
            toggleSidebar(false);
        }

        loadMessages(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ–±—â–µ–≥–æ —á–∞—Ç–∞
    document.querySelector('[data-recipient="null"]')?.addEventListener('click', (e) => {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é
        e.stopPropagation();
        selectChat(null, "–û–±—â–∏–π —á–∞—Ç", "üåê");
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function loadUsers() {
        fetch('/users')
            .then(res => {
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                return res.json();
            })
            .then(usernames => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç "–û–±—â–∏–π —á–∞—Ç"
                const generalItem = usersList.querySelector('[data-recipient="null"]');
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º "–û–±—â–∏–π —á–∞—Ç"
                usersList.innerHTML = '';
                if (generalItem) usersList.appendChild(generalItem);

                usernames.forEach(username => {
                    if (username !== currentUser) {
                        const li = document.createElement('li');
                        li.className = 'user flex items-center p-3 rounded-lg cursor-pointer hover:bg-blue-50 text-gray-800';
                        li.dataset.recipient = username;

                        const avatar = document.createElement('div');
                        avatar.className = 'w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center text-white text-sm';
                        avatar.textContent = username.charAt(0).toUpperCase();

                        const info = document.createElement('div');
                        info.className = 'ml-3';
                        info.innerHTML = `<div class="font-medium">${username}</div>`;

                        li.appendChild(avatar);
                        li.appendChild(info);

                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                        li.addEventListener('click', (e) => {
                             // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é
                            e.stopPropagation();
                            selectChat(username, username, username.charAt(0).toUpperCase());
                        });

                        usersList.appendChild(li);
                    }
                });
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err));
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function loadMessages() {
        fetch('/messages')
            .then(res => {
                 if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
                 return res.json();
            })
            .then(data => {
                messagesDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
                data.forEach(msg => {
                    if (isMessageRelevant(msg)) {
                        addMessageToChat(msg.username, msg.message, msg.time, msg.recipient);
                    }
                });
                scrollToBottom();
            })
             .catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', err));
    }

    function isMessageRelevant(msg) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
        if (currentRecipient === null) {
            // –û–±—â–∏–π —á–∞—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            return msg.recipient === null || msg.recipient === undefined || msg.recipient === '';
        } else {
            // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º
            return (
                (msg.username === currentUser && msg.recipient === currentRecipient) ||
                (msg.username === currentRecipient && msg.recipient === currentUser)
            );
        }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    function addMessageToChat(username, message, time, recipient) {
        const isSent = username === currentUser;
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${isSent ? 'justify-end' : 'justify-start'} px-1`;

        const bubble = document.createElement('div');
        // –£–ø—Ä–æ—â–∞–µ–º –∫–ª–∞—Å—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è Tailwind
        bubble.className = `max-w-[85%] md:max-w-[70%] px-4 py-2.5 rounded-message text-base leading-tight ${
            isSent
                ? 'bg-msg-sent text-white rounded-tr-sm'
                : 'bg-white text-gray-800 rounded-tl-sm border border-gray-200 shadow-sm'
        }`;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–∞—Ö –∏–ª–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –≤ –æ–±—â–µ–º)
        let senderInfo = '';
        if (currentRecipient !== null && !isSent) {
             // –í –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
             senderInfo = `<div class="text-xs opacity-70 mb-0.5 font-medium">${username}</div>`;
        } else if (currentRecipient === null && !isSent) {
            // –í –æ–±—â–µ–º —á–∞—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è –≤—Å–µ—Ö —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            senderInfo = `<div class="text-xs opacity-70 mb-0.5 font-medium">${username}</div>`;
        }
        // –î–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π senderInfo –æ—Å—Ç–∞–µ—Ç—Å—è –ø—É—Å—Ç—ã–º

        const statusIcon = isSent ? '<i class="fas fa-check-double text-xs ml-1 opacity-80"></i>' : '';

        bubble.innerHTML = `
            ${senderInfo}
            <div class="flex justify-between items-end gap-1">
                <span>${message}</span>
                <span class="text-xs opacity-80 ml-2 whitespace-nowrap">${time}</span>
            </div>
            ${isSent ? `<div class="text-right mt-0.5">${statusIcon}</div>` : ''}
        `;

        wrapper.appendChild(bubble);
        messagesDiv.appendChild(wrapper);
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        socket.emit('send_message', { message, recipient: currentRecipient });
        messageInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∏–∑-–∑–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å
        // scrollToBottom(); // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
         // –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, –∫–∞–∫ –±—ã–ª–æ
         setTimeout(scrollToBottom, 100);
    });

    socket.on('receive_message', (data) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
        if (isMessageRelevant(data)) {
            addMessageToChat(data.username, data.message, data.time, data.recipient);
            scrollToBottom();
        }
         // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ —á–∞—Ç–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('load', () => {
        loadUsers();
        loadMessages(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è "–û–±—â–µ–≥–æ —á–∞—Ç–∞" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        // selectChat(null); // –£–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Å–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ loadMessages, –Ω–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
        scrollToBottom(); // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    });

    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ö–æ—Ç—è —Å–æ–∫–µ—Ç—ã –æ–±—ã—á–Ω–æ –ª—É—á—à–µ)
    // setInterval(loadMessages, 5000); // –£–º–µ–Ω—å—à–∏–ª –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –±–æ–ª–µ–µ –∂–∏–≤–æ–≥–æ feel

</script>
</body>
</html>